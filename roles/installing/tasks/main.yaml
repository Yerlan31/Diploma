---
- name: Create containerd config file
  file:
    path: "/etc/modules-load.d/containerd.conf"
    state: "touch"

- name: Add conf for containerd
  blockinfile:
    path: "/etc/modules-load.d/containerd.conf"
    block: |
          overlay
          br_netfilter

- name: Load overlay and br_netfilter kernel modules
  community.general.modprobe:
    name: {{item}}
    state: present
  with_items:
    - overlay
    - br_netfilter


- name: Set system configurations for Kubernetes networking
  file:
    path: "/etc/sysctl.d/99-kubernetes-cri.conf"
    state: "touch"

- name: Add conf for containerd
  blockinfile:
    path: "/etc/sysctl.d/99-kubernetes-cri.conf"
    block: |
          net.bridge.bridge-nf-call-iptables = 1
          net.ipv4.ip_forward = 1
          net.bridge.bridge-nf-call-ip6tables = 1

- name: Apply new settings
  command: sudo sysctl --system

- name: Update Package Cache (apt/Ubuntu)
  become: yes
  apt:
    update_cache: yes
  changed_when: false
  when: ansible_distribution == "Ubuntu"

- name: install containerd
  ansible.builtin.package:
    name: containerd.io
    state: present

- name: Create /etc/containerd
  become: yes
  file:
    path: /etc/containerd
    state: directory
    mode: 0755

- name: Restart containerd
  ansible.builtin.systemd:
    state: restarted
    name: containerd

- name: disable swap
  shell: |
          sudo swapoff -a
          sudo sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab


- name: install apt-transport-https, curl
  ansible.builtin.package:
    name: {{ item }}
    state: present
  with_items:
    - apt-transport-https
    - curl

- name: Add google key
  apt_key:
    url: https://packages.cloud.google.com/apt/doc/apt-key.gpg 
    state: present

- name: Create kubernetes repo file
  file:
    path: "/etc/apt/sources.list.d/kubernetes.list"
    state: "touch"

- name: Add K8s Source
  blockinfile:
    path: "/etc/apt/sources.list.d/kubernetes.list"
    block: |
          deb https://apt.kubernetes.io/ kubernetes-xenial main

- name: install kubernetes
  shell: |
          sudo apt-get install -y kubelet=1.26.0-00 kubeadm=1.26.0-00 kubectl=1.26.0-00
          sudo apt-mark hold kubelet kubeadm kubectl
 
#- name: install containerd
#  ansible.builtin.package:
#    name: {{ item }}
#    state: present
#    with_items:
#      - kubeadm=1.26.0-00
#      - kubelet=1.26.0-00
#      - kubectl=1.26.0-00
 
# - name: Hold kubeadm
#  ansible.builtin.dpkg_selections:
#    name: {{ item }}
#    selection: hold
#    with_items:
#      - kubeadm
#      - kubelet
#      - kubectl
          
      
